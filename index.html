<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détecteur d'État Émotionnel Intelligent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .custom-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #3b82f6;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .custom-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: -2px;
            left: 3px;
            color: white;
            font-weight: bold;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .notification-enter {
            animation: slideIn 0.3s ease-out;
        }
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <p>Chargement de l'application...</p>
        <p style="font-size: 12px; margin-top: 10px; opacity: 0.7;">Si le chargement prend trop de temps, rafraîchissez la page</p>
    </div>
    <div id="root" style="display: none;"></div>
    <div id="error" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 90%; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h2 style="color: #ef4444; margin-bottom: 10px;">⚠️ Erreur de chargement</h2>
        <p style="margin-bottom: 15px;">L'application n'a pas pu se charger correctement.</p>
        <button onclick="location.reload()" style="background: #3b82f6; color: white; padding: 10px<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détecteur d'État Émotionnel Intelligent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .custom-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #3b82f6;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .custom-checkbox:checked::after {
            content: '✓';
            position: absolute;
            top: -2px;
            left: 3px;
            color: white;
            font-weight: bold;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .notification-enter {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configuration Google Drive
        const CLIENT_ID = '829427849836-a1pi07g2qgt73874te51at84d62jfqk7.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];

        // Questions du questionnaire
        const questions = [
            {
                id: 'pain',
                question: "Ressentez-vous des douleurs physiques ?",
                type: 'single',
                options: [
                    "Aucune gêne",
                    "Légère tension, supportable",
                    "Douleur modérée mais gérable",
                    "Douleur marquée qui me préoccupe",
                    "Douleur intense difficile à ignorer"
                ]
            },
            {
                id: 'sensations',
                question: "Quelles sensations corporelles ressentez-vous ? (plusieurs choix possibles)",
                type: 'multiple',
                options: [
                    "Fatigue générale",
                    "Maux de tête",
                    "Troubles digestifs",
                    "Tensions cervicales",
                    "Courbatures",
                    "Vertiges",
                    "Palpitations",
                    "Frissons",
                    "Bouffées de chaleur"
                ]
            },
            {
                id: 'vitality',
                question: "Comment évaluez-vous votre vitalité générale ?",
                type: 'single',
                options: [
                    "Affaibli comme si je couvais quelque chose",
                    "Fatigué mais fonctionnel",
                    "État moyen, ni bien ni mal",
                    "Plutôt en forme",
                    "Débordant d'énergie"
                ]
            },
            {
                id: 'energy',
                question: "Quel est votre niveau d'énergie ?",
                type: 'single',
                options: [
                    "Complètement à plat",
                    "Peu d'énergie, tout demande un effort",
                    "Énergie moyenne, je fais le nécessaire",
                    "Bonne énergie, je suis actif",
                    "Plein d'énergie, j'ai envie d'entreprendre"
                ]
            },
            {
                id: 'emotions',
                question: "Quelles émotions ressentez-vous en ce moment ? (plusieurs choix possibles)",
                type: 'multiple',
                options: [
                    "Tristesse",
                    "Anxiété",
                    "Colère",
                    "Joie",
                    "Confusion",
                    "Ennui",
                    "Sérénité",
                    "Frustration",
                    "Espoir",
                    "Nostalgie"
                ]
            },
            {
                id: 'atmosphere',
                question: "Comment décririez-vous votre atmosphère émotionnelle dominante ?",
                type: 'single',
                options: [
                    "Sombre, tout semble difficile",
                    "Grise, sans couleur particulière",
                    "Neutre, ni positive ni négative",
                    "Plutôt lumineuse avec quelques nuages",
                    "Radieuse, tout semble possible"
                ]
            },
            {
                id: 'physical_state',
                question: "Comment est votre état physique/posture ?",
                type: 'single',
                options: [
                    "Crispé, rigide",
                    "Tendu par endroits",
                    "Normal, sans tension particulière",
                    "Plutôt détendu",
                    "Parfaitement relâché et fluide"
                ]
            },
            {
                id: 'mental_flow',
                question: "Comment décririez-vous votre flux mental ?",
                type: 'single',
                options: [
                    "Brouillard confus",
                    "Pensées agitées, difficiles à contrôler",
                    "Flux normal avec quelques perturbations",
                    "Plutôt clair et organisé",
                    "Lac paisible cristallin"
                ]
            },
            {
                id: 'social',
                question: "Comment vous sentez-vous vis-à-vis des autres ?",
                type: 'single',
                options: [
                    "J'évite le contact",
                    "Je tolère mais sans plus",
                    "Neutre, ça dépend des personnes",
                    "Plutôt ouvert aux échanges",
                    "J'ai envie de connecter"
                ]
            },
            {
                id: 'motivation',
                question: "Quel est votre niveau de motivation ?",
                type: 'single',
                options: [
                    "Inexistante",
                    "Très faible, je me force",
                    "Moyenne, je fais ce qu'il faut",
                    "Bonne, j'ai envie d'avancer",
                    "Forte, j'ai des projets"
                ]
            },
            {
                id: 'time_perception',
                question: "Comment percevez-vous le temps qui passe ?",
                type: 'single',
                options: [
                    "Tout va trop vite, je suis dépassé",
                    "Le temps file et je cours après",
                    "Rythme normal, je suis dans le flux",
                    "J'ai le temps de faire ce que je veux",
                    "Parfaitement synchronisé avec mon rythme"
                ]
            }
        ];

        // États possibles et leurs conditions
        const possibleStates = [
            {
                id: 'migraine',
                name: "Syndrome migraineux avec nausées",
                description: "Vous semblez souffrir d'un épisode migraineux accompagné de troubles digestifs. Votre corps réclame du repos et des soins adaptés.",
                confidence: 85,
                conditions: (answers) => {
                    return answers.pain >= 3 && 
                           answers.sensations.includes("Maux de tête") && 
                           answers.sensations.includes("Troubles digestifs");
                },
                suggestions: [
                    "Reposez-vous dans un endroit calme et sombre",
                    "Hydratez-vous régulièrement par petites gorgées",
                    "Évitez les écrans et les stimuli visuels",
                    "Consultez un médecin si les symptômes persistent"
                ]
            },
            {
                id: 'flu_like',
                name: "État pseudo-grippal multi-symptomatique",
                description: "Votre corps montre plusieurs signes d'un état infectieux ou d'épuisement profond. Il est temps de prendre soin de vous.",
                confidence: 80,
                conditions: (answers) => {
                    const symptoms = answers.sensations;
                    return answers.vitality <= 1 && 
                           symptoms.length >= 4 &&
                           (symptoms.includes("Fatigue générale") || symptoms.includes("Courbatures"));
                },
                suggestions: [
                    "Prenez votre température et surveillez votre état",
                    "Reposez-vous autant que possible",
                    "Mangez léger et hydratez-vous bien",
                    "Consultez un professionnel de santé si nécessaire"
                ]
            },
            {
                id: 'depression_anxiety',
                name: "État dépressivo-anxieux mixte",
                description: "Vous traversez une période difficile où tristesse et anxiété se mélangent, affectant votre énergie et motivation.",
                confidence: 75,
                conditions: (answers) => {
                    const emotions = answers.emotions;
                    return emotions.includes("Tristesse") && 
                           emotions.includes("Anxiété") &&
                           answers.motivation <= 1 &&
                           answers.atmosphere <= 1;
                },
                suggestions: [
                    "Reconnaissez vos émotions sans jugement",
                    "Pratiquez des exercices de respiration",
                    "Maintenez une routine quotidienne simple",
                    "N'hésitez pas à demander de l'aide professionnelle"
                ]
            },
            {
                id: 'stress_overload',
                name: "Stress physico-mental avec surcharge",
                description: "Votre système est en surcharge, manifestant à la fois des tensions physiques et mentales importantes.",
                confidence: 78,
                conditions: (answers) => {
                    return answers.physical_state <= 1 &&
                           answers.mental_flow <= 1 &&
                           answers.time_perception <= 1 &&
                           answers.sensations.includes("Tensions cervicales");
                },
                suggestions: [
                    "Faites des pauses régulières dans votre journée",
                    "Pratiquez des étirements doux",
                    "Établissez des priorités claires",
                    "Essayez la méditation ou la relaxation guidée"
                ]
            },
            {
                id: 'positive_energy',
                name: "Dynamisme positif et énergie créatrice",
                description: "Vous êtes dans une excellente phase d'énergie positive, avec une bonne vitalité et un mental clair.",
                confidence: 90,
                conditions: (answers) => {
                    return answers.energy >= 4 &&
                           answers.vitality >= 4 &&
                           answers.motivation >= 4 &&
                           answers.atmosphere >= 4;
                },
                suggestions: [
                    "Profitez de cette énergie pour vos projets",
                    "Partagez votre positivité avec votre entourage",
                    "Lancez-vous dans de nouvelles activités",
                    "Notez vos idées créatives"
                ]
            },
            {
                id: 'balanced',
                name: "Équilibre harmonieux corps-esprit",
                description: "Vous êtes dans un état d'équilibre satisfaisant, avec une bonne harmonie entre vos dimensions physique et mentale.",
                confidence: 88,
                conditions: (answers) => {
                    const emotionsCount = answers.emotions.length;
                    return answers.pain <= 1 &&
                           answers.energy >= 3 &&
                           answers.mental_flow >= 4 &&
                           answers.emotions.includes("Sérénité") &&
                           emotionsCount <= 3;
                },
                suggestions: [
                    "Maintenez vos bonnes habitudes actuelles",
                    "Continuez vos pratiques de bien-être",
                    "Restez à l'écoute de vos besoins",
                    "Cultivez cette harmonie au quotidien"
                ]
            },
            {
                id: 'emotional_turmoil',
                name: "Tumulte émotionnel complexe",
                description: "Vous vivez un tourbillon d'émotions contradictoires qui créent de la confusion et de l'instabilité.",
                confidence: 70,
                conditions: (answers) => {
                    return answers.emotions.length >= 3 &&
                           answers.emotions.includes("Confusion") &&
                           answers.mental_flow <= 2;
                },
                suggestions: [
                    "Prenez du temps pour identifier chaque émotion",
                    "Écrivez vos pensées pour clarifier",
                    "Parlez à quelqu'un de confiance",
                    "Acceptez la complexité de vos ressentis"
                ]
            },
            {
                id: 'neutral',
                name: "État neutre de transition",
                description: "Vous êtes dans une phase neutre, ni particulièrement positive ni négative, possiblement en transition.",
                confidence: 65,
                conditions: (answers) => {
                    return answers.atmosphere === 2 &&
                           answers.energy === 2 &&
                           answers.motivation === 2;
                },
                suggestions: [
                    "Observez cette neutralité sans jugement",
                    "C'est peut-être le moment de faire le point",
                    "Explorez doucement de nouvelles activités",
                    "Restez ouvert aux changements à venir"
                ]
            }
        ];

        function EmotionDetectorApp() {
            const [currentTab, setCurrentTab] = useState('analyze');
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [answers, setAnswers] = useState({});
            const [multipleSelections, setMultipleSelections] = useState([]);
            const [showResult, setShowResult] = useState(false);
            const [detectedState, setDetectedState] = useState(null);
            const [history, setHistory] = useState([]);
            const [learningDB, setLearningDB] = useState([]);
            const [customAnswersDB, setCustomAnswersDB] = useState({});
            const [showCustomAnswer, setShowCustomAnswer] = useState(false);
            const [customAnswerText, setCustomAnswerText] = useState('');
            const [driveConnected, setDriveConnected] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [notification, setNotification] = useState(null);
            const [driveStatus, setDriveStatus] = useState('disconnected'); // disconnected, connecting, connected, error
            const [lastSyncTime, setLastSyncTime] = useState(null);
            const saveTimeout = useRef(null);

            // Afficher une notification
            const showNotification = (message, type = 'info') => {
                setNotification({ message, type });
                // Plus longue durée pour les erreurs
                const duration = type === 'error' ? 5000 : 3000;
                setTimeout(() => setNotification(null), duration);
            // Forcer la synchronisation manuelle
            const forceSyncWithDrive = async () => {
                if (!driveConnected) return;
                
                setIsSaving(true);
                showNotification('🔄 Synchronisation en cours...', 'info');
                
                try {
                    await saveData();
                    await loadFromGoogleDrive();
                    setLastSyncTime(new Date());
                    showNotification('✅ Synchronisation réussie !', 'success');
                } catch (error) {
                    showNotification('❌ Erreur lors de la synchronisation', 'error');
                }
                
                setIsSaving(false);
            };

            // Initialisation
            useEffect(() => {
                loadLocalData();
                initializeGoogleDrive();
            }, []);

            // Sauvegarde automatique
            useEffect(() => {
                if (saveTimeout.current) {
                    clearTimeout(saveTimeout.current);
                }
                saveTimeout.current = setTimeout(() => {
                    saveData();
                }, 2000);
            }, [history, learningDB, customAnswersDB]);

            const loadLocalData = () => {
                try {
                    const savedData = localStorage.getItem('emotionDetectorData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        setHistory(data.history || []);
                        setLearningDB(data.learningDB || []);
                        setCustomAnswersDB(data.customAnswersDB || {});
                    }
                } catch (error) {
                    console.error('Erreur lors du chargement des données locales:', error);
                }
            };

            const saveData = async () => {
                const data = {
                    history,
                    learningDB,
                    customAnswersDB,
                    lastSync: new Date().toISOString(),
                    version: '1.0'
                };

                // Sauvegarde locale
                localStorage.setItem('emotionDetectorData', JSON.stringify(data));

                // Sauvegarde Google Drive si connecté
                if (driveConnected && window.gapi && window.gapi.client) {
                    setIsSaving(true);
                    try {
                        await saveToGoogleDrive(data);
                        setLastSyncTime(new Date());
                    } catch (error) {
                        console.error('Erreur lors de la sauvegarde sur Drive:', error);
                    }
                    setIsSaving(false);
                }
            };

            const initializeGoogleDrive = () => {
                setDriveStatus('connecting');
                window.gapi.load('client:auth2', () => {
                    window.gapi.client.init({
                        clientId: CLIENT_ID,
                        discoveryDocs: DISCOVERY_DOCS,
                        scope: SCOPES
                    }).then(() => {
                        const authInstance = window.gapi.auth2.getAuthInstance();
                        const isSignedIn = authInstance.isSignedIn.get();
                        
                        setDriveConnected(isSignedIn);
                        setDriveStatus(isSignedIn ? 'connected' : 'disconnected');
                        
                        authInstance.isSignedIn.listen((signedIn) => {
                            setDriveConnected(signedIn);
                            setDriveStatus(signedIn ? 'connected' : 'disconnected');
                            
                            if (signedIn) {
                                showNotification('✅ Connexion Google Drive réussie !', 'success');
                                testDriveConnection();
                            } else {
                                showNotification('⚠️ Déconnecté de Google Drive', 'warning');
                            }
                        });
                        
                        if (isSignedIn) {
                            loadFromGoogleDrive();
                        }
                    }).catch(error => {
                        console.error('Erreur initialisation Google API:', error);
                        setDriveStatus('error');
                        showNotification('❌ Erreur lors de l\'initialisation de Google Drive', 'error');
                    });
                });
            };

            const connectGoogleDrive = () => {
                setDriveStatus('connecting');
                window.gapi.auth2.getAuthInstance().signIn()
                    .catch(error => {
                        console.error('Erreur connexion:', error);
                        setDriveStatus('disconnected');
                        showNotification('❌ Erreur lors de la connexion', 'error');
                    });
            };

            // Test de connexion pour vérifier que tout fonctionne
            const testDriveConnection = async () => {
                try {
                    await window.gapi.client.drive.files.list({
                        q: "name='emotion-detector-test'",
                        spaces: 'appDataFolder',
                        fields: 'files(id, name)'
                    });
                    showNotification('✅ Google Drive est opérationnel !', 'success');
                } catch (error) {
                    console.error('Test connexion échoué:', error);
                    setDriveStatus('error');
                    showNotification('⚠️ Connexion établie mais accès Drive limité', 'warning');
                }
            };

            const saveToGoogleDrive = async (data) => {
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";

                const metadata = {
                    'name': 'emotion-detector-data.json',
                    'mimeType': 'application/json',
                    'parents': ['appDataFolder']
                };

                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(data) +
                    close_delim;

                try {
                    // Vérifier si le fichier existe déjà
                    const response = await window.gapi.client.drive.files.list({
                        q: "name='emotion-detector-data.json'",
                        spaces: 'appDataFolder',
                        fields: 'files(id, name)'
                    });

                    const files = response.result.files;
                    if (files && files.length > 0) {
                        // Mettre à jour le fichier existant
                        await window.gapi.client.request({
                            'path': '/upload/drive/v3/files/' + files[0].id,
                            'method': 'PATCH',
                            'params': {'uploadType': 'multipart'},
                            'headers': {
                                'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                            },
                            'body': multipartRequestBody
                        });
                    } else {
                        // Créer un nouveau fichier
                        await window.gapi.client.request({
                            'path': '/upload/drive/v3/files',
                            'method': 'POST',
                            'params': {'uploadType': 'multipart'},
                            'headers': {
                                'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                            },
                            'body': multipartRequestBody
                        });
                    }
                    // Notification discrète de succès (pas de notification car c'est automatique)
                } catch (error) {
                    console.error('Erreur sauvegarde Drive:', error);
                    showNotification('⚠️ Erreur lors de la sauvegarde sur Drive', 'error');
                    throw error;
                }
            };

            const loadFromGoogleDrive = async () => {
                try {
                    const response = await window.gapi.client.drive.files.list({
                        q: "name='emotion-detector-data.json'",
                        spaces: 'appDataFolder',
                        fields: 'files(id, name)'
                    });

                    const files = response.result.files;
                    if (files && files.length > 0) {
                        const file = await window.gapi.client.drive.files.get({
                            fileId: files[0].id,
                            alt: 'media'
                        });

                        const data = JSON.parse(file.body);
                        setHistory(data.history || []);
                        setLearningDB(data.learningDB || []);
                        setCustomAnswersDB(data.customAnswersDB || {});
                        setLastSyncTime(new Date());
                        
                        showNotification('✅ Données synchronisées depuis Google Drive', 'success');
                    } else {
                        showNotification('ℹ️ Aucune donnée sauvegardée trouvée', 'info');
                    }
                } catch (error) {
                    console.error('Erreur lors du chargement depuis Drive:', error);
                    showNotification('⚠️ Impossible de charger les données depuis Drive', 'error');
                }
            };

            const handleAnswer = (answer) => {
                const question = questions[currentQuestion];
                
                if (question.type === 'single') {
                    const newAnswers = { ...answers, [question.id]: answer };
                    setAnswers(newAnswers);
                    
                    if (currentQuestion < questions.length - 1) {
                        setCurrentQuestion(currentQuestion + 1);
                    } else {
                        analyzeState(newAnswers);
                    }
                } else if (question.type === 'multiple') {
                    const newSelections = multipleSelections.includes(answer)
                        ? multipleSelections.filter(a => a !== answer)
                        : [...multipleSelections, answer];
                    setMultipleSelections(newSelections);
                }
            };

            const handleMultipleNext = () => {
                const question = questions[currentQuestion];
                const newAnswers = { ...answers, [question.id]: multipleSelections };
                setAnswers(newAnswers);
                setMultipleSelections([]);
                
                if (currentQuestion < questions.length - 1) {
                    setCurrentQuestion(currentQuestion + 1);
                } else {
                    analyzeState(newAnswers);
                }
            };

            const analyzeState = (allAnswers) => {
                // Chercher d'abord dans les apprentissages
                const learnedState = findLearnedState(allAnswers);
                if (learnedState) {
                    setDetectedState({
                        ...learnedState,
                        isLearned: true
                    });
                } else {
                    // Sinon utiliser l'algorithme de base
                    let bestMatch = null;
                    let highestConfidence = 0;

                    for (const state of possibleStates) {
                        if (state.conditions(allAnswers)) {
                            if (state.confidence > highestConfidence) {
                                highestConfidence = state.confidence;
                                bestMatch = state;
                            }
                        }
                    }

                    if (!bestMatch) {
                        bestMatch = possibleStates.find(s => s.id === 'neutral');
                    }

                    setDetectedState(bestMatch);
                }

                setShowResult(true);
            };

            const findLearnedState = (currentAnswers) => {
                for (const learned of learningDB) {
                    let similarCount = 0;
                    const requiredSimilarity = 6;

                    for (const key in learned.pattern) {
                        if (Array.isArray(learned.pattern[key])) {
                            if (JSON.stringify(learned.pattern[key].sort()) === 
                                JSON.stringify(currentAnswers[key]?.sort())) {
                                similarCount++;
                            }
                        } else {
                            if (learned.pattern[key] === currentAnswers[key]) {
                                similarCount++;
                            }
                        }
                    }

                    if (similarCount >= requiredSimilarity) {
                        return possibleStates.find(s => s.id === learned.correctState);
                    }
                }
                return null;
            };

            const handleValidation = (isCorrect) => {
                const entry = {
                    date: new Date().toISOString(),
                    state: detectedState.id,
                    confidence: detectedState.confidence,
                    answers: answers,
                    isCorrect: isCorrect,
                    isLearned: detectedState.isLearned || false
                };

                setHistory([...history, entry]);

                if (!isCorrect) {
                    // Demander le vrai état
                    const stateName = prompt("Quel était votre véritable état ?");
                    if (stateName) {
                        const newLearning = {
                            pattern: answers,
                            correctState: detectedState.id, // À améliorer avec une sélection
                            addedDate: new Date().toISOString()
                        };
                        setLearningDB([...learningDB, newLearning]);
                    }
                }

                resetQuiz();
            };

            const resetQuiz = () => {
                setCurrentQuestion(0);
                setAnswers({});
                setMultipleSelections([]);
                setShowResult(false);
                setDetectedState(null);
            };

            const addCustomAnswer = () => {
                if (customAnswerText.trim()) {
                    const question = questions[currentQuestion];
                    const questionAnswers = customAnswersDB[question.id] || {};
                    
                    if (!questionAnswers[customAnswerText]) {
                        questionAnswers[customAnswerText] = { count: 0, promoted: false };
                    }
                    
                    questionAnswers[customAnswerText].count++;
                    
                    if (questionAnswers[customAnswerText].count >= 3) {
                        questionAnswers[customAnswerText].promoted = true;
                    }

                    setCustomAnswersDB({
                        ...customAnswersDB,
                        [question.id]: questionAnswers
                    });

                    handleAnswer(customAnswerText);
                    setCustomAnswerText('');
                    setShowCustomAnswer(false);
                }
            };

            const getQuestionOptions = (question) => {
                const customOptions = customAnswersDB[question.id] || {};
                const promotedOptions = Object.entries(customOptions)
                    .filter(([_, data]) => data.promoted)
                    .map(([text, _]) => ({ text, isPromoted: true }));
                
                const defaultOptions = question.options.map(opt => ({ text: opt, isPromoted: false }));
                
                return [...promotedOptions, ...defaultOptions];
            };

            const calculateStats = () => {
                const total = history.length;
                const thisWeek = history.filter(h => {
                    const date = new Date(h.date);
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return date > weekAgo;
                }).length;
                
                const thisMonth = history.filter(h => {
                    const date = new Date(h.date);
                    const monthAgo = new Date();
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    return date > monthAgo;
                }).length;

                const correct = history.filter(h => h.isCorrect).length;
                const precision = total > 0 ? Math.round((correct / total) * 100) : 0;

                const stateFrequency = {};
                history.forEach(h => {
                    stateFrequency[h.state] = (stateFrequency[h.state] || 0) + 1;
                });

                const mostFrequent = Object.entries(stateFrequency)
                    .sort(([,a], [,b]) => b - a)[0];

                return {
                    total,
                    thisWeek,
                    thisMonth,
                    learnings: learningDB.length,
                    precision,
                    mostFrequent: mostFrequent ? {
                        state: possibleStates.find(s => s.id === mostFrequent[0])?.name,
                        count: mostFrequent[1]
                    } : null
                };
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    {/* Notification */}
                    {notification && (
                        <div className={`fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 notification-enter ${
                            notification.type === 'success' ? 'bg-green-500 text-white' :
                            notification.type === 'error' ? 'bg-red-500 text-white' :
                            notification.type === 'warning' ? 'bg-yellow-500 text-white' :
                            'bg-blue-500 text-white'
                        }`}>
                            <div className="flex items-center gap-2">
                                {notification.type === 'success' && (
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                    </svg>
                                )}
                                {notification.type === 'error' && (
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                )}
                                {notification.type === 'warning' && (
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                )}
                                <span>{notification.message}</span>
                            </div>
                        </div>
                    )}

                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-4xl">
                        {/* Header avec tabs */}
                        <div className="border-b border-gray-200">
                            <div className="flex justify-between items-center p-6">
                                <h1 className="text-2xl font-bold text-gray-800">
                                    🧠 Détecteur d'État Émotionnel
                                </h1>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setCurrentTab('analyze')}
                                        className={`px-4 py-2 rounded-lg transition-colors ${
                                            currentTab === 'analyze' 
                                                ? 'bg-blue-500 text-white' 
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        Analyse
                                    </button>
                                    <button
                                        onClick={() => setCurrentTab('history')}
                                        className={`px-4 py-2 rounded-lg transition-colors ${
                                            currentTab === 'history' 
                                                ? 'bg-blue-500 text-white' 
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        Historique ({history.length})
                                    </button>
                                    <button
                                        onClick={driveStatus === 'disconnected' ? connectGoogleDrive : null}
                                        disabled={driveStatus === 'connecting'}
                                        className={`px-4 py-2 rounded-lg transition-colors flex items-center gap-2 ${
                                            driveStatus === 'connected' ? 'bg-green-500 text-white' :
                                            driveStatus === 'connecting' ? 'bg-gray-400 text-white cursor-wait' :
                                            driveStatus === 'error' ? 'bg-red-500 text-white hover:bg-red-600' :
                                            'bg-yellow-500 text-white hover:bg-yellow-600'
                                        }`}
                                    >
                                        {driveStatus === 'connected' ? (
                                            <>
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                                </svg>
                                                Drive ✓
                                            </>
                                        ) : driveStatus === 'connecting' ? (
                                            <>
                                                <svg className="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                                Connexion...
                                            </>
                                        ) : driveStatus === 'error' ? (
                                            <>
                                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                                Erreur Drive
                                            </>
                                        ) : (
                                            'Connecter Drive'
                                        )}
                                    </button>
                                </div>
                            </div>
                            {driveConnected && (
                                <div className="px-6 pb-2 flex items-center justify-between text-sm">
                                    <div className="flex items-center gap-2 text-green-600">
                                        <svg className="w-4 h-4 animate-pulse" fill="currentColor" viewBox="0 0 24 24">
                                            <circle cx="12" cy="12" r="3"/>
                                        </svg>
                                        <span>
                                            🔄 Sauvegarde automatique activée
                                            {isSaving && ' (enregistrement...)'}
                                        </span>
                                    </div>
                                    <button
                                        onClick={forceSyncWithDrive}
                                        disabled={isSaving}
                                        className="text-blue-600 hover:text-blue-800 font-medium disabled:text-gray-400"
                                    >
                                        Forcer la synchronisation
                                    </button>
                                </div>
                            )}
                        </div>

                        {/* Contenu principal */}
                        <div className="p-6">
                            {currentTab === 'analyze' && !showResult && (
                                <div>
                                    {/* Barre de progression */}
                                    <div className="mb-6">
                                        <div className="flex justify-between text-sm text-gray-600 mb-2">
                                            <span>Question {currentQuestion + 1} sur {questions.length}</span>
                                            <span>{Math.round(((currentQuestion + 1) / questions.length) * 100)}%</span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-2">
                                            <div 
                                                className="bg-blue-500 h-2 rounded-full transition-all duration-300"
                                                style={{ width: `${((currentQuestion + 1) / questions.length) * 100}%` }}
                                            />
                                        </div>
                                    </div>

                                    {/* Question */}
                                    <div className="mb-6">
                                        <h2 className="text-xl font-semibold text-gray-800 mb-4">
                                            {questions[currentQuestion].question}
                                        </h2>

                                        {/* Options */}
                                        <div className="space-y-2">
                                            {getQuestionOptions(questions[currentQuestion]).map((option, index) => (
                                                <div key={index} className="relative">
                                                    {questions[currentQuestion].type === 'single' ? (
                                                        <button
                                                            onClick={() => handleAnswer(option.text)}
                                                            className="w-full text-left p-4 rounded-lg border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition-all duration-200"
                                                        >
                                                            {option.text}
                                                            {option.isPromoted && (
                                                                <span className="ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">
                                                                    ★ Promu
                                                                </span>
                                                            )}
                                                        </button>
                                                    ) : (
                                                        <label className="flex items-center p-4 rounded-lg border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                className="custom-checkbox mr-3"
                                                                checked={multipleSelections.includes(option.text)}
                                                                onChange={() => handleAnswer(option.text)}
                                                            />
                                                            <span className="flex-1">
                                                                {option.text}
                                                                {option.isPromoted && (
                                                                    <span className="ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">
                                                                        ★ Promu
                                                                    </span>
                                                                )}
                                                            </span>
                                                        </label>
                                                    )}
                                                </div>
                                            ))}
                                        </div>

                                        {/* Bouton réponse personnalisée */}
                                        <button
                                            onClick={() => setShowCustomAnswer(!showCustomAnswer)}
                                            className="mt-4 text-blue-600 hover:text-blue-800 text-sm font-medium"
                                        >
                                            ✏️ Autre réponse...
                                        </button>

                                        {showCustomAnswer && (
                                            <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                                                <h3 className="font-medium text-gray-700 mb-2">
                                                    Réponse personnalisée
                                                </h3>
                                                
                                                {/* Réponses précédentes */}
                                                {Object.entries(customAnswersDB[questions[currentQuestion].id] || {}).length > 0 && (
                                                    <div className="mb-3">
                                                        <p className="text-sm text-gray-600 mb-1">
                                                            Vos réponses précédentes :
                                                        </p>
                                                        <div className="space-y-1">
                                                            {Object.entries(customAnswersDB[questions[currentQuestion].id] || {})
                                                                .sort(([,a], [,b]) => b.count - a.count)
                                                                .map(([text, data]) => (
                                                                    <button
                                                                        key={text}
                                                                        onClick={() => {
                                                                            handleAnswer(text);
                                                                            setShowCustomAnswer(false);
                                                                        }}
                                                                        className="text-left w-full p-2 text-sm bg-white rounded border hover:bg-blue-50"
                                                                    >
                                                                        {text} ({data.count} fois)
                                                                    </button>
                                                                ))}
                                                        </div>
                                                    </div>
                                                )}

                                                <div className="flex gap-2">
                                                    <input
                                                        type="text"
                                                        value={customAnswerText}
                                                        onChange={(e) => setCustomAnswerText(e.target.value)}
                                                        onKeyPress={(e) => e.key === 'Enter' && addCustomAnswer()}
                                                        placeholder="Votre réponse..."
                                                        className="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    />
                                                    <button
                                                        onClick={addCustomAnswer}
                                                        className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                                                    >
                                                        Ajouter
                                                    </button>
                                                </div>
                                            </div>
                                        )}

                                        {/* Bouton suivant pour les questions multiples */}
                                        {questions[currentQuestion].type === 'multiple' && (
                                            <div className="mt-6 flex justify-between items-center">
                                                <span className="text-sm text-gray-600">
                                                    {multipleSelections.length} sélection(s)
                                                </span>
                                                <button
                                                    onClick={handleMultipleNext}
                                                    disabled={multipleSelections.length === 0}
                                                    className={`px-6 py-2 rounded-lg font-medium transition-colors ${
                                                        multipleSelections.length > 0
                                                            ? 'bg-blue-500 text-white hover:bg-blue-600'
                                                            : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                                    }`}
                                                >
                                                    Question suivante →
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {currentTab === 'analyze' && showResult && (
                                <div className="text-center">
                                    <div className="mb-6">
                                        <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <svg className="w-10 h-10 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </div>
                                        <h2 className="text-2xl font-bold text-gray-800 mb-2">
                                            {detectedState.name}
                                        </h2>
                                        {detectedState.isLearned && (
                                            <span className="inline-block px-3 py-1 bg-purple-100 text-purple-800 text-sm rounded-full mb-2">
                                                Résultat appris
                                            </span>
                                        )}
                                        <p className="text-gray-600 mb-4">
                                            {detectedState.description}
                                        </p>
                                        
                                        {/* Barre de confiance */}
                                        <div className="mb-6">
                                            <div className="flex justify-between text-sm text-gray-600 mb-1">
                                                <span>Niveau de confiance</span>
                                                <span>{detectedState.confidence}%</span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-2">
                                                <div 
                                                    className="bg-green-500 h-2 rounded-full transition-all duration-500"
                                                    style={{ width: `${detectedState.confidence}%` }}
                                                />
                                            </div>
                                        </div>

                                        {/* Suggestions */}
                                        <div className="bg-blue-50 rounded-lg p-4 mb-6">
                                            <h3 className="font-semibold text-blue-800 mb-2">
                                                Suggestions personnalisées :
                                            </h3>
                                            <ul className="text-left space-y-1">
                                                {detectedState.suggestions.map((suggestion, index) => (
                                                    <li key={index} className="text-blue-700">
                                                        • {suggestion}
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>

                                        {/* Validation */}
                                        <div className="space-y-2">
                                            <p className="text-gray-600">Cette analyse vous semble-t-elle correcte ?</p>
                                            <div className="flex gap-4 justify-center">
                                                <button
                                                    onClick={() => handleValidation(true)}
                                                    className="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
                                                >
                                                    ✓ Oui c'est juste
                                                </button>
                                                <button
                                                    onClick={() => handleValidation(false)}
                                                    className="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                                                >
                                                    ✗ Non pas vraiment
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {currentTab === 'history' && (
                                <div>
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-xl font-bold text-gray-800">
                                            Historique et statistiques
                                        </h2>
                                        {driveConnected && (
                                            <button
                                                onClick={testDriveConnection}
                                                className="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors"
                                            >
                                                Tester la connexion Drive
                                            </button>
                                        )}
                                    </div>

                                    {/* Informations de connexion Drive */}
                                    {driveStatus !== 'disconnected' && (
                                        <div className={`p-4 rounded-lg mb-6 ${
                                            driveStatus === 'connected' ? 'bg-green-50 border border-green-200' :
                                            driveStatus === 'connecting' ? 'bg-blue-50 border border-blue-200' :
                                            'bg-red-50 border border-red-200'
                                        }`}>
                                            <h3 className={`font-semibold mb-2 ${
                                                driveStatus === 'connected' ? 'text-green-800' :
                                                driveStatus === 'connecting' ? 'text-blue-800' :
                                                'text-red-800'
                                            }`}>
                                                État de la connexion Google Drive
                                            </h3>
                                            <p className={`text-sm ${
                                                driveStatus === 'connected' ? 'text-green-700' :
                                                driveStatus === 'connecting' ? 'text-blue-700' :
                                                'text-red-700'
                                            }`}>
                                                {driveStatus === 'connected' ? 
                                                    '✅ Connecté - Vos données sont automatiquement synchronisées' :
                                                driveStatus === 'connecting' ? 
                                                    '⏳ Connexion en cours...' :
                                                    '❌ Erreur de connexion - Vérifiez vos paramètres Google'}
                                            </p>
                                            {driveStatus === 'connected' && (
                                                <>
                                                    <p className="text-xs text-green-600 mt-1">
                                                        Les données sont sauvegardées dans votre espace privé Google Drive
                                                    </p>
                                                    {lastSyncTime && (
                                                        <p className="text-xs text-green-600 mt-1">
                                                            Dernière synchronisation : {lastSyncTime.toLocaleTimeString('fr-FR')}
                                                        </p>
                                                    )}
                                                </>
                                            )}
                                        </div>
                                    )}

                                    {/* Statistiques */}
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                        {(() => {
                                            const stats = calculateStats();
                                            return (
                                                <>
                                                    <div className="bg-blue-50 p-4 rounded-lg">
                                                        <div className="text-2xl font-bold text-blue-600">
                                                            {stats.total}
                                                        </div>
                                                        <div className="text-sm text-gray-600">
                                                            Analyses totales
                                                        </div>
                                                    </div>
                                                    <div className="bg-green-50 p-4 rounded-lg">
                                                        <div className="text-2xl font-bold text-green-600">
                                                            {stats.thisWeek}
                                                        </div>
                                                        <div className="text-sm text-gray-600">
                                                            Cette semaine
                                                        </div>
                                                    </div>
                                                    <div className="bg-purple-50 p-4 rounded-lg">
                                                        <div className="text-2xl font-bold text-purple-600">
                                                            {stats.learnings}
                                                        </div>
                                                        <div className="text-sm text-gray-600">
                                                            Apprentissages
                                                        </div>
                                                    </div>
                                                    <div className="bg-yellow-50 p-4 rounded-lg">
                                                        <div className="text-2xl font-bold text-yellow-600">
                                                            {stats.precision}%
                                                        </div>
                                                        <div className="text-sm text-gray-600">
                                                            Précision
                                                        </div>
                                                    </div>
                                                </>
                                            );
                                        })()}
                                    </div>

                                    {/* État le plus fréquent */}
                                    {(() => {
                                        const stats = calculateStats();
                                        return stats.mostFrequent && (
                                            <div className="bg-indigo-50 p-4 rounded-lg mb-6">
                                                <h3 className="font-semibold text-indigo-800 mb-1">
                                                    État le plus fréquent ce mois :
                                                </h3>
                                                <p className="text-indigo-700">
                                                    {stats.mostFrequent.state} ({stats.mostFrequent.count} fois)
                                                </p>
                                            </div>
                                        );
                                    })()}

                                    {/* Liste historique */}
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {history.length === 0 ? (
                                            <p className="text-gray-500 text-center py-8">
                                                Aucune analyse enregistrée pour le moment
                                            </p>
                                        ) : (
                                            [...history].reverse().map((entry, index) => {
                                                const state = possibleStates.find(s => s.id === entry.state);
                                                return (
                                                    <div key={index} className="border rounded-lg p-4 hover:bg-gray-50">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div>
                                                                <h4 className="font-semibold text-gray-800">
                                                                    {state?.name || 'État inconnu'}
                                                                </h4>
                                                                <p className="text-sm text-gray-600">
                                                                    {new Date(entry.date).toLocaleString('fr-FR')}
                                                                </p>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                {entry.isLearned && (
                                                                    <span className="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded">
                                                                        Appris
                                                                    </span>
                                                                )}
                                                                <span className={`px-2 py-1 text-xs rounded ${
                                                                    entry.isCorrect 
                                                                        ? 'bg-green-100 text-green-800' 
                                                                        : 'bg-red-100 text-red-800'
                                                                }`}>
                                                                    {entry.isCorrect ? 'Correct' : 'Incorrect'}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div className="text-sm text-gray-500">
                                                            Confiance : {entry.confidence}%
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<EmotionDetectorApp />, document.getElementById('root'));
    </script>
</body>
</html>
