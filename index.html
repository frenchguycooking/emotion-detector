<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D√©tecteur d'√âtat √âmotionnel Intelligent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .custom-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #3b82f6;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        .custom-checkbox:checked::after {
            content: '‚úì';
            position: absolute;
            top: -2px;
            left: 3px;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configuration Google Drive
        const CLIENT_ID = '829427849836-a1pi07g2qgt73874te51at84d62jfqk7.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];

        // Questions du questionnaire
        const questions = [
            {
                id: 'pain',
                question: "Ressentez-vous des douleurs physiques ?",
                type: 'single',
                options: [
                    "Aucune g√™ne",
                    "L√©g√®re tension, supportable",
                    "Douleur mod√©r√©e mais g√©rable",
                    "Douleur marqu√©e qui me pr√©occupe",
                    "Douleur intense difficile √† ignorer"
                ]
            },
            {
                id: 'sensations',
                question: "Quelles sensations corporelles ressentez-vous ? (plusieurs choix possibles)",
                type: 'multiple',
                options: [
                    "Fatigue g√©n√©rale",
                    "Maux de t√™te",
                    "Troubles digestifs",
                    "Tensions cervicales",
                    "Courbatures",
                    "Vertiges",
                    "Palpitations",
                    "Frissons",
                    "Bouff√©es de chaleur"
                ]
            },
            {
                id: 'vitality',
                question: "Comment √©valuez-vous votre vitalit√© g√©n√©rale ?",
                type: 'single',
                options: [
                    "Affaibli comme si je couvais quelque chose",
                    "Fatigu√© mais fonctionnel",
                    "√âtat moyen, ni bien ni mal",
                    "Plut√¥t en forme",
                    "D√©bordant d'√©nergie"
                ]
            },
            {
                id: 'energy',
                question: "Quel est votre niveau d'√©nergie ?",
                type: 'single',
                options: [
                    "Compl√®tement √† plat",
                    "Peu d'√©nergie, tout demande un effort",
                    "√ânergie moyenne, je fais le n√©cessaire",
                    "Bonne √©nergie, je suis actif",
                    "Plein d'√©nergie, j'ai envie d'entreprendre"
                ]
            },
            {
                id: 'emotions',
                question: "Quelles √©motions ressentez-vous en ce moment ? (plusieurs choix possibles)",
                type: 'multiple',
                options: [
                    "Tristesse",
                    "Anxi√©t√©",
                    "Col√®re",
                    "Joie",
                    "Confusion",
                    "Ennui",
                    "S√©r√©nit√©",
                    "Frustration",
                    "Espoir",
                    "Nostalgie"
                ]
            },
            {
                id: 'atmosphere',
                question: "Comment d√©cririez-vous votre atmosph√®re √©motionnelle dominante ?",
                type: 'single',
                options: [
                    "Sombre, tout semble difficile",
                    "Grise, sans couleur particuli√®re",
                    "Neutre, ni positive ni n√©gative",
                    "Plut√¥t lumineuse avec quelques nuages",
                    "Radieuse, tout semble possible"
                ]
            },
            {
                id: 'physical_state',
                question: "Comment est votre √©tat physique/posture ?",
                type: 'single',
                options: [
                    "Crisp√©, rigide",
                    "Tendu par endroits",
                    "Normal, sans tension particuli√®re",
                    "Plut√¥t d√©tendu",
                    "Parfaitement rel√¢ch√© et fluide"
                ]
            },
            {
                id: 'mental_flow',
                question: "Comment d√©cririez-vous votre flux mental ?",
                type: 'single',
                options: [
                    "Brouillard confus",
                    "Pens√©es agit√©es, difficiles √† contr√¥ler",
                    "Flux normal avec quelques perturbations",
                    "Plut√¥t clair et organis√©",
                    "Lac paisible cristallin"
                ]
            },
            {
                id: 'social',
                question: "Comment vous sentez-vous vis-√†-vis des autres ?",
                type: 'single',
                options: [
                    "J'√©vite le contact",
                    "Je tol√®re mais sans plus",
                    "Neutre, √ßa d√©pend des personnes",
                    "Plut√¥t ouvert aux √©changes",
                    "J'ai envie de connecter"
                ]
            },
            {
                id: 'motivation',
                question: "Quel est votre niveau de motivation ?",
                type: 'single',
                options: [
                    "Inexistante",
                    "Tr√®s faible, je me force",
                    "Moyenne, je fais ce qu'il faut",
                    "Bonne, j'ai envie d'avancer",
                    "Forte, j'ai des projets"
                ]
            },
            {
                id: 'time_perception',
                question: "Comment percevez-vous le temps qui passe ?",
                type: 'single',
                options: [
                    "Tout va trop vite, je suis d√©pass√©",
                    "Le temps file et je cours apr√®s",
                    "Rythme normal, je suis dans le flux",
                    "J'ai le temps de faire ce que je veux",
                    "Parfaitement synchronis√© avec mon rythme"
                ]
            }
        ];

        // √âtats possibles et leurs conditions
        const possibleStates = [
            {
                id: 'migraine',
                name: "Syndrome migraineux avec naus√©es",
                description: "Vous semblez souffrir d'un √©pisode migraineux accompagn√© de troubles digestifs. Votre corps r√©clame du repos et des soins adapt√©s.",
                confidence: 85,
                conditions: (answers) => {
                    return answers.pain >= 3 && 
                           answers.sensations.includes("Maux de t√™te") && 
                           answers.sensations.includes("Troubles digestifs");
                },
                suggestions: [
                    "Reposez-vous dans un endroit calme et sombre",
                    "Hydratez-vous r√©guli√®rement par petites gorg√©es",
                    "√âvitez les √©crans et les stimuli visuels",
                    "Consultez un m√©decin si les sympt√¥mes persistent"
                ]
            },
            {
                id: 'flu_like',
                name: "√âtat pseudo-grippal multi-symptomatique",
                description: "Votre corps montre plusieurs signes d'un √©tat infectieux ou d'√©puisement profond. Il est temps de prendre soin de vous.",
                confidence: 80,
                conditions: (answers) => {
                    const symptoms = answers.sensations;
                    return answers.vitality <= 1 && 
                           symptoms.length >= 4 &&
                           (symptoms.includes("Fatigue g√©n√©rale") || symptoms.includes("Courbatures"));
                },
                suggestions: [
                    "Prenez votre temp√©rature et surveillez votre √©tat",
                    "Reposez-vous autant que possible",
                    "Mangez l√©ger et hydratez-vous bien",
                    "Consultez un professionnel de sant√© si n√©cessaire"
                ]
            },
            {
                id: 'depression_anxiety',
                name: "√âtat d√©pressivo-anxieux mixte",
                description: "Vous traversez une p√©riode difficile o√π tristesse et anxi√©t√© se m√©langent, affectant votre √©nergie et motivation.",
                confidence: 75,
                conditions: (answers) => {
                    const emotions = answers.emotions;
                    return emotions.includes("Tristesse") && 
                           emotions.includes("Anxi√©t√©") &&
                           answers.motivation <= 1 &&
                           answers.atmosphere <= 1;
                },
                suggestions: [
                    "Reconnaissez vos √©motions sans jugement",
                    "Pratiquez des exercices de respiration",
                    "Maintenez une routine quotidienne simple",
                    "N'h√©sitez pas √† demander de l'aide professionnelle"
                ]
            },
            {
                id: 'stress_overload',
                name: "Stress physico-mental avec surcharge",
                description: "Votre syst√®me est en surcharge, manifestant √† la fois des tensions physiques et mentales importantes.",
                confidence: 78,
                conditions: (answers) => {
                    return answers.physical_state <= 1 &&
                           answers.mental_flow <= 1 &&
                           answers.time_perception <= 1 &&
                           answers.sensations.includes("Tensions cervicales");
                },
                suggestions: [
                    "Faites des pauses r√©guli√®res dans votre journ√©e",
                    "Pratiquez des √©tirements doux",
                    "√âtablissez des priorit√©s claires",
                    "Essayez la m√©ditation ou la relaxation guid√©e"
                ]
            },
            {
                id: 'positive_energy',
                name: "Dynamisme positif et √©nergie cr√©atrice",
                description: "Vous √™tes dans une excellente phase d'√©nergie positive, avec une bonne vitalit√© et un mental clair.",
                confidence: 90,
                conditions: (answers) => {
                    return answers.energy >= 4 &&
                           answers.vitality >= 4 &&
                           answers.motivation >= 4 &&
                           answers.atmosphere >= 4;
                },
                suggestions: [
                    "Profitez de cette √©nergie pour vos projets",
                    "Partagez votre positivit√© avec votre entourage",
                    "Lancez-vous dans de nouvelles activit√©s",
                    "Notez vos id√©es cr√©atives"
                ]
            },
            {
                id: 'balanced',
                name: "√âquilibre harmonieux corps-esprit",
                description: "Vous √™tes dans un √©tat d'√©quilibre satisfaisant, avec une bonne harmonie entre vos dimensions physique et mentale.",
                confidence: 88,
                conditions: (answers) => {
                    const emotionsCount = answers.emotions.length;
                    return answers.pain <= 1 &&
                           answers.energy >= 3 &&
                           answers.mental_flow >= 4 &&
                           answers.emotions.includes("S√©r√©nit√©") &&
                           emotionsCount <= 3;
                },
                suggestions: [
                    "Maintenez vos bonnes habitudes actuelles",
                    "Continuez vos pratiques de bien-√™tre",
                    "Restez √† l'√©coute de vos besoins",
                    "Cultivez cette harmonie au quotidien"
                ]
            },
            {
                id: 'emotional_turmoil',
                name: "Tumulte √©motionnel complexe",
                description: "Vous vivez un tourbillon d'√©motions contradictoires qui cr√©ent de la confusion et de l'instabilit√©.",
                confidence: 70,
                conditions: (answers) => {
                    return answers.emotions.length >= 3 &&
                           answers.emotions.includes("Confusion") &&
                           answers.mental_flow <= 2;
                },
                suggestions: [
                    "Prenez du temps pour identifier chaque √©motion",
                    "√âcrivez vos pens√©es pour clarifier",
                    "Parlez √† quelqu'un de confiance",
                    "Acceptez la complexit√© de vos ressentis"
                ]
            },
            {
                id: 'neutral',
                name: "√âtat neutre de transition",
                description: "Vous √™tes dans une phase neutre, ni particuli√®rement positive ni n√©gative, possiblement en transition.",
                confidence: 65,
                conditions: (answers) => {
                    return answers.atmosphere === 2 &&
                           answers.energy === 2 &&
                           answers.motivation === 2;
                },
                suggestions: [
                    "Observez cette neutralit√© sans jugement",
                    "C'est peut-√™tre le moment de faire le point",
                    "Explorez doucement de nouvelles activit√©s",
                    "Restez ouvert aux changements √† venir"
                ]
            }
        ];

        function EmotionDetectorApp() {
            const [currentTab, setCurrentTab] = useState('analyze');
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [answers, setAnswers] = useState({});
            const [multipleSelections, setMultipleSelections] = useState([]);
            const [showResult, setShowResult] = useState(false);
            const [detectedState, setDetectedState] = useState(null);
            const [history, setHistory] = useState([]);
            const [learningDB, setLearningDB] = useState([]);
            const [customAnswersDB, setCustomAnswersDB] = useState({});
            const [showCustomAnswer, setShowCustomAnswer] = useState(false);
            const [customAnswerText, setCustomAnswerText] = useState('');
            const [driveConnected, setDriveConnected] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const saveTimeout = useRef(null);

            // Initialisation
            useEffect(() => {
                loadLocalData();
                initializeGoogleDrive();
            }, []);

            // Sauvegarde automatique
            useEffect(() => {
                if (saveTimeout.current) {
                    clearTimeout(saveTimeout.current);
                }
                saveTimeout.current = setTimeout(() => {
                    saveData();
                }, 2000);
            }, [history, learningDB, customAnswersDB]);

            const loadLocalData = () => {
                try {
                    const savedData = localStorage.getItem('emotionDetectorData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        setHistory(data.history || []);
                        setLearningDB(data.learningDB || []);
                        setCustomAnswersDB(data.customAnswersDB || {});
                    }
                } catch (error) {
                    console.error('Erreur lors du chargement des donn√©es locales:', error);
                }
            };

            const saveData = async () => {
                const data = {
                    history,
                    learningDB,
                    customAnswersDB,
                    lastSync: new Date().toISOString(),
                    version: '1.0'
                };

                // Sauvegarde locale
                localStorage.setItem('emotionDetectorData', JSON.stringify(data));

                // Sauvegarde Google Drive si connect√©
                if (driveConnected && window.gapi && window.gapi.client) {
                    setIsSaving(true);
                    try {
                        await saveToGoogleDrive(data);
                    } catch (error) {
                        console.error('Erreur lors de la sauvegarde sur Drive:', error);
                    }
                    setIsSaving(false);
                }
            };

            const initializeGoogleDrive = () => {
                window.gapi.load('client:auth2', () => {
                    window.gapi.client.init({
                        clientId: CLIENT_ID,
                        discoveryDocs: DISCOVERY_DOCS,
                        scope: SCOPES
                    }).then(() => {
                        const authInstance = window.gapi.auth2.getAuthInstance();
                        setDriveConnected(authInstance.isSignedIn.get());
                        authInstance.isSignedIn.listen(setDriveConnected);
                        
                        if (authInstance.isSignedIn.get()) {
                            loadFromGoogleDrive();
                        }
                    });
                });
            };

            const connectGoogleDrive = () => {
                window.gapi.auth2.getAuthInstance().signIn();
            };

            const saveToGoogleDrive = async (data) => {
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";

                const metadata = {
                    'name': 'emotion-detector-data.json',
                    'mimeType': 'application/json',
                    'parents': ['appDataFolder']
                };

                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(metadata) +
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(data) +
                    close_delim;

                // V√©rifier si le fichier existe d√©j√†
                const response = await window.gapi.client.drive.files.list({
                    q: "name='emotion-detector-data.json'",
                    spaces: 'appDataFolder',
                    fields: 'files(id, name)'
                });

                const files = response.result.files;
                if (files && files.length > 0) {
                    // Mettre √† jour le fichier existant
                    await window.gapi.client.request({
                        'path': '/upload/drive/v3/files/' + files[0].id,
                        'method': 'PATCH',
                        'params': {'uploadType': 'multipart'},
                        'headers': {
                            'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                        },
                        'body': multipartRequestBody
                    });
                } else {
                    // Cr√©er un nouveau fichier
                    await window.gapi.client.request({
                        'path': '/upload/drive/v3/files',
                        'method': 'POST',
                        'params': {'uploadType': 'multipart'},
                        'headers': {
                            'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                        },
                        'body': multipartRequestBody
                    });
                }
            };

            const loadFromGoogleDrive = async () => {
                try {
                    const response = await window.gapi.client.drive.files.list({
                        q: "name='emotion-detector-data.json'",
                        spaces: 'appDataFolder',
                        fields: 'files(id, name)'
                    });

                    const files = response.result.files;
                    if (files && files.length > 0) {
                        const file = await window.gapi.client.drive.files.get({
                            fileId: files[0].id,
                            alt: 'media'
                        });

                        const data = JSON.parse(file.body);
                        setHistory(data.history || []);
                        setLearningDB(data.learningDB || []);
                        setCustomAnswersDB(data.customAnswersDB || {});
                    }
                } catch (error) {
                    console.error('Erreur lors du chargement depuis Drive:', error);
                }
            };

            const handleAnswer = (answer) => {
                const question = questions[currentQuestion];
                
                if (question.type === 'single') {
                    const newAnswers = { ...answers, [question.id]: answer };
                    setAnswers(newAnswers);
                    
                    if (currentQuestion < questions.length - 1) {
                        setCurrentQuestion(currentQuestion + 1);
                    } else {
                        analyzeState(newAnswers);
                    }
                } else if (question.type === 'multiple') {
                    const newSelections = multipleSelections.includes(answer)
                        ? multipleSelections.filter(a => a !== answer)
                        : [...multipleSelections, answer];
                    setMultipleSelections(newSelections);
                }
            };

            const handleMultipleNext = () => {
                const question = questions[currentQuestion];
                const newAnswers = { ...answers, [question.id]: multipleSelections };
                setAnswers(newAnswers);
                setMultipleSelections([]);
                
                if (currentQuestion < questions.length - 1) {
                    setCurrentQuestion(currentQuestion + 1);
                } else {
                    analyzeState(newAnswers);
                }
            };

            const analyzeState = (allAnswers) => {
                // Chercher d'abord dans les apprentissages
                const learnedState = findLearnedState(allAnswers);
                if (learnedState) {
                    setDetectedState({
                        ...learnedState,
                        isLearned: true
                    });
                } else {
                    // Sinon utiliser l'algorithme de base
                    let bestMatch = null;
                    let highestConfidence = 0;

                    for (const state of possibleStates) {
                        if (state.conditions(allAnswers)) {
                            if (state.confidence > highestConfidence) {
                                highestConfidence = state.confidence;
                                bestMatch = state;
                            }
                        }
                    }

                    if (!bestMatch) {
                        bestMatch = possibleStates.find(s => s.id === 'neutral');
                    }

                    setDetectedState(bestMatch);
                }

                setShowResult(true);
            };

            const findLearnedState = (currentAnswers) => {
                for (const learned of learningDB) {
                    let similarCount = 0;
                    const requiredSimilarity = 6;

                    for (const key in learned.pattern) {
                        if (Array.isArray(learned.pattern[key])) {
                            if (JSON.stringify(learned.pattern[key].sort()) === 
                                JSON.stringify(currentAnswers[key]?.sort())) {
                                similarCount++;
                            }
                        } else {
                            if (learned.pattern[key] === currentAnswers[key]) {
                                similarCount++;
                            }
                        }
                    }

                    if (similarCount >= requiredSimilarity) {
                        return possibleStates.find(s => s.id === learned.correctState);
                    }
                }
                return null;
            };

            const handleValidation = (isCorrect) => {
                const entry = {
                    date: new Date().toISOString(),
                    state: detectedState.id,
                    confidence: detectedState.confidence,
                    answers: answers,
                    isCorrect: isCorrect,
                    isLearned: detectedState.isLearned || false
                };

                setHistory([...history, entry]);

                if (!isCorrect) {
                    // Demander le vrai √©tat
                    const stateName = prompt("Quel √©tait votre v√©ritable √©tat ?");
                    if (stateName) {
                        const newLearning = {
                            pattern: answers,
                            correctState: detectedState.id, // √Ä am√©liorer avec une s√©lection
                            addedDate: new Date().toISOString()
                        };
                        setLearningDB([...learningDB, newLearning]);
                    }
                }

                resetQuiz();
            };

            const resetQuiz = () => {
                setCurrentQuestion(0);
                setAnswers({});
                setMultipleSelections([]);
                setShowResult(false);
                setDetectedState(null);
            };

            const addCustomAnswer = () => {
                if (customAnswerText.trim()) {
                    const question = questions[currentQuestion];
                    const questionAnswers = customAnswersDB[question.id] || {};
                    
                    if (!questionAnswers[customAnswerText]) {
                        questionAnswers[customAnswerText] = { count: 0, promoted: false };
                    }
                    
                    questionAnswers[customAnswerText].count++;
                    
                    if (questionAnswers[customAnswerText].count >= 3) {
                        questionAnswers[customAnswerText].promoted = true;
                    }

                    setCustomAnswersDB({
                        ...customAnswersDB,
                        [question.id]: questionAnswers
                    });

                    handleAnswer(customAnswerText);
                    setCustomAnswerText('');
                    setShowCustomAnswer(false);
                }
            };

            const getQuestionOptions = (question) => {
                const customOptions = customAnswersDB[question.id] || {};
                const promotedOptions = Object.entries(customOptions)
                    .filter(([_, data]) => data.promoted)
                    .map(([text, _]) => ({ text, isPromoted: true }));
                
                const defaultOptions = question.options.map(opt => ({ text: opt, isPromoted: false }));
                
                return [...promotedOptions, ...defaultOptions];
            };

            const calculateStats = () => {
                const total = history.length;
                const thisWeek = history.filter(h => {
                    const date = new Date(h.date);
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    return date > weekAgo;
                }).length;
                
                const thisMonth = history.filter(h => {
                    const date = new Date(h.date);
                    const monthAgo = new Date();
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    return date > monthAgo;
                }).length;

                const correct = history.filter(h => h.isCorrect).length;
                const precision = total > 0 ? Math.round((correct / total) * 100) : 0;

                const stateFrequency = {};
                history.forEach(h => {
                    stateFrequency[h.state] = (stateFrequency[h.state] || 0) + 1;
                });

                const mostFrequent = Object.entries(stateFrequency)
                    .sort(([,a], [,b]) => b - a)[0];

                return {
                    total,
                    thisWeek,
                    thisMonth,
                    learnings: learningDB.length,
                    precision,
                    mostFrequent: mostFrequent ? {
                        state: possibleStates.find(s => s.id === mostFrequent[0])?.name,
                        count: mostFrequent[1]
                    } : null
                };
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-4xl">
                        {/* Header avec tabs */}
                        <div className="border-b border-gray-200">
                            <div className="flex justify-between items-center p-6">
                                <h1 className="text-2xl font-bold text-gray-800">
                                    üß† D√©tecteur d'√âtat √âmotionnel
                                </h1>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setCurrentTab('analyze')}
                                        className={`px-4 py-2 rounded-lg transition-colors ${
                                            currentTab === 'analyze' 
                                                ? 'bg-blue-500 text-white' 
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        Analyse
                                    </button>
                                    <button
                                        onClick={() => setCurrentTab('history')}
                                        className={`px-4 py-2 rounded-lg transition-colors ${
                                            currentTab === 'history' 
                                                ? 'bg-blue-500 text-white' 
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        Historique ({history.length})
                                    </button>
                                    <button
                                        onClick={driveConnected ? null : connectGoogleDrive}
                                        className={`px-4 py-2 rounded-lg transition-colors ${
                                            driveConnected 
                                                ? 'bg-green-500 text-white' 
                                                : 'bg-yellow-500 text-white hover:bg-yellow-600'
                                        }`}
                                    >
                                        {driveConnected ? 'Drive ‚úì' : 'Connecter Drive'}
                                    </button>
                                </div>
                            </div>
                            {driveConnected && (
                                <div className="px-6 pb-2 text-sm text-green-600">
                                    üîÑ Sauvegarde automatique activ√©e
                                    {isSaving && ' (enregistrement...)'}
                                </div>
                            )}
                        </div>

                        {/* Contenu principal */}
                        <div className="p-6">
                            {currentTab === 'analyze' && !showResult && (
                                <div>
                                    {/* Barre de progression */}
                                    <div className="mb-6">
                                        <div className="flex justify-between text-sm text-gray-600 mb-2">
                                            <span>Question {currentQuestion + 1} sur {questions.length}</span>
                                            <span>{Math.round(((currentQuestion + 1) / questions.length) * 100)}%</span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-2">
                                            <div 
                                                className="bg-blue-500 h-2 rounded-full transition-all duration-300"
                                                style={{ width: `${((currentQuestion + 1) / questions.length) * 100}%` }}
                                            />
                                        </div>
                                    </div>

                                    {/* Question */}
                                    <div className="mb-6">
                                        <h2 className="text-xl font-semibold text-gray-800 mb-4">
                                            {questions[currentQuestion].question}
                                        </h2>

                                        {/* Options */}
                                        <div className="space-y-2">
                                            {getQuestionOptions(questions[currentQuestion]).map((option, index) => (
                                                <div key={index} className="relative">
                                                    {questions[currentQuestion].type === 'single' ? (
                                                        <button
                                                            onClick={() => handleAnswer(option.text)}
                                                            className="w-full text-left p-4 rounded-lg border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition-all duration-200"
                                                        >
                                                            {option.text}
                                                            {option.isPromoted && (
                                                                <span className="ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">
                                                                    ‚òÖ Promu
                                                                </span>
                                                            )}
                                                        </button>
                                                    ) : (
                                                        <label className="flex items-center p-4 rounded-lg border-2 border-gray-200 hover:border-blue-500 hover:bg-blue-50 transition-all duration-200 cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                className="custom-checkbox mr-3"
                                                                checked={multipleSelections.includes(option.text)}
                                                                onChange={() => handleAnswer(option.text)}
                                                            />
                                                            <span className="flex-1">
                                                                {option.text}
                                                                {option.isPromoted && (
                                                                    <span className="ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded">
                                                                        ‚òÖ Promu
                                                                    </span>
                                                                )}
                                                            </span>
                                                        </label>
                                                    )}
                                                </div>
                                            ))}
                                        </div>

                                        {/* Bouton r√©ponse personnalis√©e */}
                                        <button
                                            onClick={() => setShowCustomAnswer(!showCustomAnswer)}
                                            className="mt-4 text-blue-600 hover:text-blue-800 text-sm font-medium"
                                        >
                                            ‚úèÔ∏è Autre r√©ponse...
                                        </button>

                                        {showCustomAnswer && (
                                            <div className="mt-4 p-4 bg-gray-50 rounded-lg">
                                                <h3 className="font-medium text-gray-700 mb-2">
                                                    R√©ponse personnalis√©e
                                                </h3>
                                                
                                                {/* R√©ponses pr√©c√©dentes */}
                                                {Object.entries(customAnswersDB[questions[currentQuestion].id] || {}).length > 0 && (
                                                    <div className="mb-3">
                                                        <p className="text-sm text-gray-600 mb-1">
                                                            Vos r√©ponses pr√©c√©dentes :
                                                        </p>
                                                        <div className="space-y-1">
                                                            {Object.entries(customAnswersDB[questions[currentQuestion].id] || {})
                                                                .sort(([,a], [,b]) => b.count - a.count)
                                                                .map(([text, data]) => (
                                                                    <button
                                                                        key={text}
                                                                        onClick={() => {
                                                                            handleAnswer(text);
                                                                            setShowCustomAnswer(false);
                                                                        }}
                                                                        className="text-left w-full p-2 text-sm bg-white rounded border hover:bg-blue-50"
                                                                    >
                                                                        {text} ({data.count} fois)
                                                                    </button>
                                                                ))}
                                                        </div>
                                                    </div>
                                                )}

                                                <div className="flex gap-2">
                                                    <input
                                                        type="text"
                                                        value={customAnswerText}
                                                        onChange={(e) => setCustomAnswerText(e.target.value)}
                                                        onKeyPress={(e) => e.key === 'Enter' && addCustomAnswer()}
                                                        placeholder="Votre r√©ponse..."
                                                        className="flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    />
                                                    <button
                                                        onClick={addCustomAnswer}
                                                        className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                                                    >
                                                        Ajouter
                                                    </button>
                                                </div>
                                            </div>
                                        )}

                                        {/* Bouton suivant pour les questions multiples */}
                                        {questions[currentQuestion].type === 'multiple' && (
                                            <div className="mt-6 flex justify-between items-center">
                                                <span className="text-sm text-gray-600">
                                                    {multipleSelections.length} s√©lection(s)
                                                </span>
                                                <button
                                                    onClick={handleMultipleNext}
                                                    disabled={multipleSelections.length === 0}
                                                    className={`px-6 py-2 rounded-lg font-medium transition-colors ${
                                                        multipleSelections.length > 0
                                                            ? 'bg-blue-500 text-white hover:bg-blue-600'
                                                            : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                                    }`}
                                                >
                                                    Question suivante ‚Üí
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {currentTab === 'analyze' && showResult && (
                                <div className="text-center">
                                    <div className="mb-6">
                                        <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <svg className="w-10 h-10 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </div>
                                        <h2 className="text-2xl font-bold text-gray-800 mb-2">
                                            {detectedState.name}
                                        </h2>
                                        {detectedState.isLearned && (
                                            <span className="inline-block px-3 py-1 bg-purple-100 text-purple-800 text-sm rounded-full mb-2">
                                                R√©sultat appris
                                            </span>
                                        )}
                                        <p className="text-gray-600 mb-4">
                                            {detectedState.description}
                                        </p>
                                        
                                        {/* Barre de confiance */}
                                        <div className="mb-6">
                                            <div className="flex justify-between text-sm text-gray-600 mb-1">
                                                <span>Niveau de confiance</span>
                                                <span>{detectedState.confidence}%</span>
                                            </div>
                                            <div className="w-full bg-gray-200 rounded-full h-2">
                                                <div 
                                                    className="bg-green-500 h-2 rounded-full transition-all duration-500"
                                                    style={{ width: `${detectedState.confidence}%` }}
                                                />
                                            </div>
                                        </div>

                                        {/* Suggestions */}
                                        <div className="bg-blue-50 rounded-lg p-4 mb-6">
                                            <h3 className="font-semibold text-blue-800 mb-2">
                                                Suggestions personnalis√©es :
                                            </h3>
                                            <ul className="text-left space-y-1">
                                                {detectedState.suggestions.map((suggestion, index) => (
                                                    <li key={index} className="text-blue-700">
                                                        ‚Ä¢ {suggestion}
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>

                                        {/* Validation */}
                                        <div className="space-y-2">
                                            <p className="text-gray-600">Cette analyse vous semble-t-elle correcte ?</p>
                                            <div className="flex gap-4 justify-center">
                                                <button
                                                    onClick={() => handleValidation(true)}
                                                    className="px-6 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors"
                                                >
                                                    ‚úì Oui c'est juste
                                                </button>
                                                <button
                                                    onClick={() => handleValidation(false)}
                                                    className="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                                                >
                                                    ‚úó Non pas vraiment
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {currentTab === 'history' && (
                                <div>
                                    <h2 className="text-xl font-bold text-gray-800 mb-6">
                                        Historique et statistiques
                                    </h2>

                                    {/* Statistiques */}
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                        {(() => {
                                            const stats = calculateStats();
                                            return (
                                                <>
                                                    <div className="bg-blue-50 p-4 rounded-lg">
                                                        <div className="text-2xl font-bold text-blue-600">
                                                            {stats.total}
                                                        </div>
                                                        <div className="text-sm text-gray-600">
                                                            Analyses totales
                                                        </div>
                                                    </div>
                                                    <div className="bg-green-50 p-4 rounded-lg">
                                                        <div className="text-2xl font-bold text-green-600">
                                                            {stats.thisWeek}
                                                        </div>
                                                        <div className="text-sm text-gray-600">
                                                            Cette semaine
                                                        </div>
                                                    </div>
                                                    <div className="bg-purple-50 p-4 rounded-lg">
                                                        <div className="text-2xl font-bold text-purple-600">
                                                            {stats.learnings}
                                                        </div>
                                                        <div className="text-sm text-gray-600">
                                                            Apprentissages
                                                        </div>
                                                    </div>
                                                    <div className="bg-yellow-50 p-4 rounded-lg">
                                                        <div className="text-2xl font-bold text-yellow-600">
                                                            {stats.precision}%
                                                        </div>
                                                        <div className="text-sm text-gray-600">
                                                            Pr√©cision
                                                        </div>
                                                    </div>
                                                </>
                                            );
                                        })()}
                                    </div>

                                    {/* √âtat le plus fr√©quent */}
                                    {(() => {
                                        const stats = calculateStats();
                                        return stats.mostFrequent && (
                                            <div className="bg-indigo-50 p-4 rounded-lg mb-6">
                                                <h3 className="font-semibold text-indigo-800 mb-1">
                                                    √âtat le plus fr√©quent ce mois :
                                                </h3>
                                                <p className="text-indigo-700">
                                                    {stats.mostFrequent.state} ({stats.mostFrequent.count} fois)
                                                </p>
                                            </div>
                                        );
                                    })()}

                                    {/* Liste historique */}
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {history.length === 0 ? (
                                            <p className="text-gray-500 text-center py-8">
                                                Aucune analyse enregistr√©e pour le moment
                                            </p>
                                        ) : (
                                            [...history].reverse().map((entry, index) => {
                                                const state = possibleStates.find(s => s.id === entry.state);
                                                return (
                                                    <div key={index} className="border rounded-lg p-4 hover:bg-gray-50">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div>
                                                                <h4 className="font-semibold text-gray-800">
                                                                    {state?.name || '√âtat inconnu'}
                                                                </h4>
                                                                <p className="text-sm text-gray-600">
                                                                    {new Date(entry.date).toLocaleString('fr-FR')}
                                                                </p>
                                                            </div>
                                                            <div className="flex gap-2">
                                                                {entry.isLearned && (
                                                                    <span className="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded">
                                                                        Appris
                                                                    </span>
                                                                )}
                                                                <span className={`px-2 py-1 text-xs rounded ${
                                                                    entry.isCorrect 
                                                                        ? 'bg-green-100 text-green-800' 
                                                                        : 'bg-red-100 text-red-800'
                                                                }`}>
                                                                    {entry.isCorrect ? 'Correct' : 'Incorrect'}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div className="text-sm text-gray-500">
                                                            Confiance : {entry.confidence}%
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<EmotionDetectorApp />, document.getElementById('root'));
    </script>
</body>
</html>
